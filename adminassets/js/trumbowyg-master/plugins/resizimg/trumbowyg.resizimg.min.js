(function($){"use strict";var defaultOptions={minSize:32,step:4};function preventDefault(e){e.stopPropagation();e.preventDefault()}var ResizeWithCanvas=function(trumbowyg){this.resizeCanvas=document.createElement("canvas");this.resizeCanvas.setAttribute("tabindex","0");this.resizeCanvas.id="trumbowyg-resizimg-"+ +new Date;this.ctx=null;this.resizeImg=null;this.pressEscape=function(obj){obj.reset()};this.pressBackspaceOrDelete=function(obj){$(obj.resizeCanvas).remove();obj.resizeImg=null;if(trumbowyg!==null){trumbowyg.syncCode();trumbowyg.$c.trigger("tbwchange")}};var focusedNow=false;var isCursorSeResize=false;var offsetX,offsetY;var reOffset=function(canvas){var BB=canvas.getBoundingClientRect();offsetX=BB.left;offsetY=BB.top};var updateCanvas=function(canvas,ctx,img,canvasWidth,canvasHeight){ctx.translate(.5,.5);ctx.lineWidth=1;ctx.drawImage(img,5,5,canvasWidth-10,canvasHeight-10);ctx.beginPath();ctx.rect(5,5,canvasWidth-10,canvasHeight-10);ctx.stroke();ctx.beginPath();ctx.fillStyle="rgb(255, 255, 255)";ctx.rect(canvasWidth-10,canvasHeight-10,9,9);ctx.fill();ctx.stroke();reOffset(canvas);return ctx};this.init=function(){var _this=this;$(window).on("scroll resize",function(){_this.reCalcOffset()})};this.reCalcOffset=function(){reOffset(this.resizeCanvas)};this.canvasId=function(){return this.resizeCanvas.id};this.isActive=function(){return this.resizeImg!==null};this.isFocusedNow=function(){return focusedNow};this.blurNow=function(){focusedNow=false};this.reset=function(){if(this.resizeImg===null){return}this.resizeImg.setAttribute("style","width: 100%; max-width: "+(this.resizeCanvas.clientWidth-10)+"px; height: auto; max-height: "+(this.resizeCanvas.clientHeight-10)+"px;");$(this.resizeCanvas).replaceWith($(this.resizeImg));this.resizeCanvas.removeAttribute("style");this.resizeImg=null};this.setup=function(img,resizableOptions){this.resizeImg=img;if(!this.resizeCanvas.getContext){return false}focusedNow=true;this.resizeCanvas.width=$(this.resizeImg).width()+10;this.resizeCanvas.height=$(this.resizeImg).height()+10;this.resizeCanvas.style.margin="-5px";this.ctx=this.resizeCanvas.getContext("2d");$(this.resizeImg).replaceWith($(this.resizeCanvas));updateCanvas(this.resizeCanvas,this.ctx,this.resizeImg,this.resizeCanvas.width,this.resizeCanvas.height);$(this.resizeCanvas).resizable(resizableOptions).on("mousedown",preventDefault);var _this=this;$(this.resizeCanvas).on("mousemove",function(e){var mouseX=Math.round(e.clientX-offsetX);var mouseY=Math.round(e.clientY-offsetY);var wasCursorSeResize=isCursorSeResize;_this.ctx.rect(_this.resizeCanvas.width-10,_this.resizeCanvas.height-10,9,9);isCursorSeResize=_this.ctx.isPointInPath(mouseX,mouseY);if(wasCursorSeResize!==isCursorSeResize){this.style.cursor=isCursorSeResize?"se-resize":"default"}}).on("keydown",function(e){if(!_this.isActive()){return}var x=e.keyCode;if(x===27){_this.pressEscape(_this)}else if(x===8||x===46){_this.pressBackspaceOrDelete(_this)}}).on("focus",preventDefault).on("blur",function(){_this.reset();if(trumbowyg!==null){trumbowyg.syncCode();trumbowyg.$c.trigger("tbwchange")}});this.resizeCanvas.focus();return true};this.refresh=function(){if(!this.resizeCanvas.getContext){return}this.resizeCanvas.width=this.resizeCanvas.clientWidth;this.resizeCanvas.height=this.resizeCanvas.clientHeight;updateCanvas(this.resizeCanvas,this.ctx,this.resizeImg,this.resizeCanvas.width,this.resizeCanvas.height)}};$.extend(true,$.trumbowyg,{plugins:{resizimg:{destroyResizable:function(){},init:function(trumbowyg){var destroyResizable=this.destroyResizable;var resizeWithCanvas=new ResizeWithCanvas(trumbowyg);this.destroyResizable=function(){trumbowyg.$ed.find("canvas.resizable").resizable("destroy").off("mousedown",preventDefault).removeClass("resizable");resizeWithCanvas.reset();trumbowyg.syncCode()};trumbowyg.o.plugins.resizimg=$.extend(true,{},defaultOptions,trumbowyg.o.plugins.resizimg||{},{resizable:{resizeWidth:false,onDragStart:function(ev,$el){var opt=trumbowyg.o.plugins.resizimg;var x=ev.pageX-$el.offset().left;var y=ev.pageY-$el.offset().top;if(x<$el.width()-opt.minSize||y<$el.height()-opt.minSize){return false}},onDrag:function(ev,$el,newWidth,newHeight){var opt=trumbowyg.o.plugins.resizimg;if(newHeight<opt.minSize){newHeight=opt.minSize}newHeight-=newHeight%opt.step;$el.height(newHeight);return false},onDragEnd:function(){resizeWithCanvas.refresh();trumbowyg.syncCode()}}});function initResizable(){trumbowyg.$ed.find("img").off("click").on("click",function(e){if(resizeWithCanvas.isActive()){resizeWithCanvas.reset()}resizeWithCanvas.setup(this,trumbowyg.o.plugins.resizimg.resizable);preventDefault(e)})}trumbowyg.$c.on("tbwinit",function(){initResizable();trumbowyg.$ed.on("click",function(e){if($(e.target).is("img")||e.target.id===resizeWithCanvas.canvasId()){return}preventDefault(e);resizeWithCanvas.reset();trumbowyg.syncCode();trumbowyg.$c.trigger("tbwchange")});trumbowyg.$ed.on("scroll",function(){resizeWithCanvas.reCalcOffset()})});trumbowyg.$c.on("tbwfocus tbwchange",initResizable);trumbowyg.$c.on("tbwresize",function(){resizeWithCanvas.reCalcOffset()});trumbowyg.$c.on("tbwblur",function(){if(resizeWithCanvas.isFocusedNow()){resizeWithCanvas.blurNow()}else{destroyResizable()}})},destroy:function(){this.destroyResizable()}}}})})(jQuery);